# Forest habitat types

```{r}

schemes_fs <- mhq_schemes %>%
  filter(typeclass %in% c("FS")) 

```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_fs$type),
                            Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling)

```

```{r}
overzicht_lsvi %>%
  datatable(rownames = FALSE,
            filter = "top")
```


## Invoergegevens

```{r}

data_habitat_mhq_fs <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_fs$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_fs$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = type_observed) %>%
  ungroup() %>%
  filter(is_maintype_target) %>%
  filter(type_observed != "91E0_sf")

data_habitat_vbi <- classif_vbi %>%
  mutate(plot_id = as.character(plot_id))

data_habitat_fs <- data_habitat_mhq_fs %>%
  bind_rows(data_habitat_vbi)

data_voorwaarden_vbi <- get_voorwaarden_fs(data_path = path_vbi,
                                          data_path_extra_var = path_extra_var,
                                          data_type = "vbi",
                                          data_habitat = data_habitat_vbi)

data_voorwaarden_mhq <- get_voorwaarden_fs(data_path = path_mhq_anb,
                                          data_path_extra_var = path_extra_var,
                                          data_type = "mhq",
                                          data_habitat = data_habitat_mhq_fs,
                                          path_vol_parameters = path_vbi)

data_voorwaarden_fs <- data_voorwaarden_vbi %>%
  bind_rows(data_voorwaarden_mhq)

data_soorten_kenm_mhq <- get_soorten_kenmerken_fs(data_path = path_mhq_anb,
                         record_ids =  data_habitat_mhq_fs$record_id_square)

data_soorten_kenm_vbi <- get_soorten_kenmerken_fs(data_path = path_vbi,
                         record_ids =  data_habitat_vbi$record_id_square,
                         data_type = "vbi")

data_soorten_kenm_fs <- data_soorten_kenm_mhq %>%
  bind_rows(data_soorten_kenm_vbi)

data_habitat_vbi_91E0_vc <- data_habitat_vbi %>%
  filter(type_observed == "91E0_vc")

data_habitat_vbi_other <- data_habitat_vbi %>%
  filter(type_observed != "91E0_vc")

data_habitat_mhq_91E0_vc <- data_habitat_mhq_fs %>%
  filter(type_observed == "91E0_vc")

data_habitat_mhq_other <- data_habitat_mhq_fs %>%
  filter(type_observed != "91E0_vc")

data_basalarea_vbi_other <- calc_basalarea_ha(data_path = path_vbi,
                                               record_ids = data_habitat_vbi_other$record_id_square,
                                               per_segment = TRUE,
                                              data_type = "vbi")

data_basalarea_vbi_91E0_vc <- calc_basalarea_ha(data_path = path_vbi,
                                               record_ids = data_habitat_vbi_91E0_vc$record_id_square,
                                               per_segment = FALSE,
                                               data_type = "vbi")

data_basalarea_mhq_other <- calc_basalarea_ha(data_path = path_mhq_anb,
                                               record_ids = data_habitat_mhq_other$record_id_square,
                                               per_segment = TRUE,
                                              data_type = "mhq")

data_basalarea_mhq_91E0_vc <- calc_basalarea_ha(data_path = path_mhq_anb,
                                               record_ids = data_habitat_mhq_91E0_vc$record_id_square,
                                               per_segment = FALSE,
                                               data_type = "mhq")
  
cover_without_populus <- data_soorten_kenm_fs %>%
  filter(!is.na(Vegetatielaag) & Vegetatielaag %in% c("boomlaag", "struiklaag")) %>%
  group_by(ID) %>%
  mutate(popolus_present = any(str_sub(Kenmerk, 1, 7) == "Populus")) %>%
  ungroup() %>%
  filter(str_sub(Kenmerk, 1, 7) != "Populus") %>%
  group_by(ID, popolus_present) %>%
  summarise(cover_treelayer_nopop = (1 - prod(1 - Waarde/100, na.rm = TRUE)) * 100) %>%
  ungroup()

data_basalarea_fs <- data_basalarea_vbi_other %>%
  bind_rows(data_basalarea_vbi_91E0_vc) %>%
  bind_rows(data_basalarea_mhq_other, data_basalarea_mhq_91E0_vc) %>%
  filter(segment_id == 1) %>%
  left_join(cover_without_populus, by = "ID") %>%
  left_join(select(data_habitat_fs, ID, type_observed), by = "ID") %>%
  mutate(Kenmerk = str_remove(Kenmerk, " species| spec"),
         Kenmerk = ifelse(Kenmerk == "Quercus robur/petraea",
                          "Quercus robur",
                          ifelse(Kenmerk == "Betula tremula/alba",
                                 ifelse(type_observed %in% c("9110", "9120", "9130", "9160", "91E0_vo", "91E0_vm"),
                                        "Betula pendula",
                                        "Betula pubescens"), 
                                 ifelse(Kenmerk == "Lariks", 
                                        "Larix", Kenmerk))),
    remove_populus = (substr(Kenmerk, 1, 7) == "Populus") &
           (substr(type_observed, 1, 4) == "91E0") &
           ((!is.na(cover_treelayer_nopop)) & (cover_treelayer_nopop >= 70)))

data_basalarea_fs <- data_basalarea_fs %>%
  filter(!remove_populus) %>%
  select(-popolus_present, -remove_populus, -cover_treelayer_nopop, -plot_id, -segment_id, -type_observed)

data_soorten_kenm_fs <- data_soorten_kenm_fs %>%
  bind_rows(data_basalarea_fs) %>%
  mutate(Kenmerk = ifelse(Kenmerk == "Loofhout", "Quercus", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Naaldhout", "Pinus", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "F. excelsior/A. pseudoplatanus", "Fraxinus excelsior", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Picaea abies", "Picea abies", Kenmerk), #foute spelling
         Kenmerk = ifelse(Kenmerk == "Platanus hispanica L.", "Platanus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Alnus x pubescens Tausch", "Alnus glutinosa x incana", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Salix x reichardtii A. Kerner", "Salix", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Taraxacum Wiggers sectie Subvulgaria Christians.", "Taraxacum Wiggers", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Populus x canadensis Moench", "Populus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Rumex x pratensis Mert. et Koch", "Rumex", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Platanus x hispanica Mill. ex Münchh.", "Platanus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Tilia x europaea L.", "Tilia", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk %in% c("Cedrus atlantica (Endl.) Carr.", "Cedrus libani A. Rich.", "Sequoiadendron giganteum", "Sequoia", "Cupressus"), "Picea", Kenmerk)) %>% #exoten die niet herkend worden 
  arrange(ID)
```

## Berekening voorwaarden

### Rechtstreeks invoer in rekenmodule

Voor de volgende voorwaarden worden de waarden rechtstreeks ingevoerd in de LSVI-rekenmodule:

* aandeel dood hout,
* hoeveelheid dik dood hout,
* bosconstantie,
* minimum structuurareaal (MSA).

\needspace{60mm}
De *bosconstantie* wordt afgeleid uit de bosleeftijdskaart en de bestandsleeftijd opgemeten op het terrein:

* bosconstantie >= 100 jaar als het meetpunt tot de klasse 'voor 1775' of 'tussen 1775 en 1850' behoort OF als de bestandsleeftijd > 100 jaar;
* bosconstantie >= 75 jaar als het meetpunt tot de klasse 'tussen 1850 en +-1930' behoort OF als de bestandsleeftijd > 80 jaar;
* bosconstantie >= 30 jaar als het meetpunt tot de klasse 'na +-1930' behoort  EN als de  bestandsleeftijd > 40 jaar heeft;
* bosconstantie < 30 jaar in alle andere gevallen.

*Aandeel dood hout* en *hoeveelheid dik dood hout* worden berekend op basis van de dendrometrische gegevens. Beide variabelen worden steeds voor de volledige plot berekend, ook al bestaat het meetpunt slechts gedeeltelijk uit doelhabitat. Voor de schatting van de toestand op basis van de tweede Bosinventarisatie en het Meetnet Habitatkwaliteit, gebruiken we gegevens van liggend en staand dood hout om beide voorwaarden te berekenen. In de eerste Bosinventarisatie werd echter enkel staand dood hout opgemeten. Voor de schatting van veranderingen tussen beide inventarisaties gebruiken we dus enkel gegevens van staand dood hout, zodat de resultaten voor beide periodes vergelijkbaar zijn. We gebruiken dan ook een aangepaste referentiewaarde voor de indicator 'aandeel dood hout', meer bepaald 2 m²/ha i.p.v. 4 m²/ha. 

Het is niet aangewezen om de indicator ‘hoeveelheid dik dood hout’ te beoordelen op meetpuntniveau. Dik dood hout is immers dermate zeldzaam, dat dit op niveau van een boscomplex zou moeten beoordeeld worden. Daarom rekenen we de beoordeling van deze indicator niet mee bij het bepalen van de status van de habitatvlek. Wel schatten we het gemiddeld aantal exemplaren dik dood hout per hectare voor geheel Vlaanderen. Door dit voor beide periodes van de Bosinventarisatie te doen, geeft dit een idee hoe de indicator evolueert in de tijd.  

### Voorwaarden berekend door rekenmodule

De overige voorwaarden van de boshabitats worden via de LSVI-rekenmodule berekend op basis van de volgende gegevens:

* de bedekking van de soorten in de vegetatieplot,
* de bedekking van de vegetatielagen in de vegetatieplot,
* de aanwezige groeiklassen,
* het grondvlak per boomsoort.

De aanwezige groeiklassen worden afgeleid uit de vegetatiegegevens (groeiklasse 2) en de dendrometrische gegevens (groeiklassen 3 tot 7).  Groeiklasse 1 (= open ruimte in bos) kan niet afgeleid worden uit de meetgegevens en ontbreekt dus steeds. Wanneer een meetpunt slechts gedeeltelijk uit doelhabitat bestaat, tellen we toch alle aanwezige groeiklasse binnen het volledige meetpunt mee. Een dikke boom uit groeiklasse 7 die niet in het doelhabitat ligt maar wel binnen het meetpunt valt (de cirkelplot met straal van 18 meter) zal dus toch meegerekend worden.

Het grondvlak per boomsoort leiden we af uit de dendrometrische gegevens. Als een meetpunt slechts gedeeltelijk uit doelhabitat bestaat, zullen we hier enkel de bomen meerekenen die gelegen zijn binnen het deel van de plot met doelhabitat. Op basis deze gegevens wordt immers de voorwaarde 'grondvlakaandeel van de sleutelsoorten in de boomlaag' bepaald. Een uitzondering hierop is habitatsubtype 91E0_vc, dat vaak slechts over een kleine oppervlakte voorkomt en waarvoor ook de bomen in de omliggende habitatvlekken (maar binnen het meetpunt) meegenomen worden voor het bepalen van het aandeel sleutelsoorten. Ten slotte rekenen we, zoals aangegeven in @TJollyn2009 en @Oosterlynck2018, bij habitattype 91E0 het grondvlak van populieren niet mee als de bedekking van de boomlaag zonder populier groter is dan 70 %. De bedekking van de boomlaag zonder populier leiden we af uit de vegetatieopname.

De voorwaarde 'schaalgrootte ingrepen (ha)', die onderdeel uitmaakt van de indicator 'horizontale structuur - natuurlijke mozaiekstructuur', kan niet worden afgeleid uit de beschikbare gegevens en en wordt daarom niet meegerekend bij de evaluatie van de LSVI.

## Volledigheid van de invoergegevens

### Specifiactie habitatsubtype

+ Indien habitatsubtype van 9130 niet gespecifieerd is veronderstellen we 9130_end
+ Indien habitatsubtype van 91E0 niet gespecifieerd is veronderstellen we 91E0_va

```{r}

subtypes_fs <- types %>%
  filter(typeclass == "FS") %>%
  filter(typelevel == "subtype") %>%
  select(type_observed = main_type, Habitattype = type) 

data_habitat_fs <- data_habitat_fs %>%
  mutate(Habitattype = ifelse(Habitattype == "9130", "9130_end",
                              ifelse(Habitattype == "91E0", "91E0_va", Habitattype)))
```

### Voorwaarden

```{r}
voorwaarden_fs  <- overzicht_lsvi %>%
  semi_join(data_voorwaarden_fs , by = "Voorwaarde") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) %>%
  mutate(Voorwaarde = ifelse(Habitatsubtype == "2310" & Indicator == "horizontale structuur", 
                             "bedekking open vegetaties en kaal zand", 
                             Voorwaarde))

check <- voorwaarden_fs %>%
  distinct(Indicator, Voorwaarde)

voorwaarde_plot_type <- data_voorwaarden_fs  %>%
  distinct(Voorwaarde, plot_type, Eenheid, Type)

check_voorwaarden <- data_habitat_fs  %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_fs , by = "Habitatsubtype") %>%
  left_join(voorwaarde_plot_type, by = "Voorwaarde") %>%
  left_join(select(data_voorwaarden_fs , -Eenheid, -Type), by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde)) %>%
  group_by(ID) %>%
  mutate(all_missing = all(is.na(Waarde))) %>%
  ungroup()

voorwaarden_record_missing <- check_voorwaarden %>%
  filter(is.na(record_id)) %>%
  select(ID, record_id_square, record_id_circle, date, Habitatsubtype, Indicator, Voorwaarde, Waarde)

plots_all_missing <- check_voorwaarden %>%
  filter(all_missing)

```

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

Bij plot '1287030_2019-08-13' ontbreken alle structuurvariabelen. 
Deze plot laten we weg uit de analyse.

```{r}

data_voorwaarden_fs <- check_voorwaarden %>%
  filter(!all_missing) %>%
  mutate(Waarde = ifelse(is.na(Waarde), 0, Waarde)) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique() %>%
  mutate(Voorwaarde = ifelse(Voorwaarde == "bedekking open vegetaties en kaal zand",
                             "bedekking open vegetaties", Voorwaarde)) %>%
  unique()
# in LSVI tabel heet de voorwaarde bij indocator horizontale structuur 'bedekking open vegetaties', maar gaat eigenlijk over 'bedekking open vegetaties en kaal zand'

data_habitat_fs <- data_habitat_fs %>%
  anti_join(plots_all_missing, by = "ID")

data_soorten_kenm_fs <- data_soorten_kenm_fs %>%
    anti_join(plots_all_missing, by = "ID")
```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_fs  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_fs, by = c("record_id"))

check_missingvalue <- data_habitat_fs  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_fs, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

missing_cover_plot <- check_missingvalue %>%
  filter(!is.na(Vegetatielaag)) %>%
  group_by(ID,survey, date, type_observed, Vegetatielaag) %>%
  summarise(any_missing_cover = any(is.na(Waarde)),
            all_missing_cover = all(is.na(Waarde)),
            prop_missing = sum(is.na(Waarde) / n()),
            n_species = n(),
            n_missing = sum(is.na(Waarde))) %>%
  ungroup() %>%
  filter(any_missing_cover)

double <- data_soorten_kenm_fs %>%
  filter(!is.na(Kenmerk)) %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)
  
data_soorten_kenm_fs <- data_soorten_kenm_fs %>%
  filter(!is.na(Kenmerk))

```

Onbekende soortnamen in kruidlaag --> Calluna dood, Erica dood
Onbekende soortnamen in korstmoslaag --> korstmos spec. 

Deze ontbrekende soortnamen hebben geen impact op LSVI

Ontbrekende bedekking van soorten soms wel een probleem: sleutelsoorten moeten talrijk aanwezig zijn voor habitattype 2330 en 4010.
Maar voornamelijk bij mossoorten ontbreken de bedekking. 
Enkel bij 2330_bu is er één mossoort (Polytrichum piliferum) bij de sleutelsoorten (die dus talrijk aanwezig moeten zijn).

Voor volgende plots ontbreekt de bedekking van Polytrichum piliferum.
Is aanwezigheid voldoende?

```{r}
check_missingvalue %>%
  filter(is.na(Waarde)) %>%
  filter(Kenmerk == "Polytrichum piliferum") %>%
  select(ID, Habitattype, Kenmerk, Waarde) %>%
  datatable(rownames = FALSE, filter = "top")
```

Voor volgende plots zijn er ontbrekende bedekkingen in de vegetatielaag.
Geen van deze plots bevat voldoende sleutelsoorten om gunstig te kunnen scoren.

```{r}
check_missingvalue %>%
filter(Vegetatielaag == "kruidlaag") %>%
  group_by(ID) %>%
  filter(any(is.na(Waarde))) %>%
  ungroup() %>%
  select(ID, Vegetatielaag, Habitattype, Kenmerk, Waarde) %>%
  datatable(rownames = FALSE,
            filter = "top")
```

```{r}
data_habitat_test <- data_habitat_fs %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup()
```

## TEST 2310

```{r}
data_habitat_test_type <- data_habitat_fs %>%
  filter(Habitattype == "2310")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Polytrichum species, Pseudoscleropodium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 476086_2014-09-04 zijn in de moslaag de synoniemen 'Polytrichum species' en 'Pseudoscleropodium species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossoorten --> heeft geen impact op LSVI --> OK


## TEST 2330_bu

```{r}
data_habitat_test_type <- data_habitat_fs %>%
  filter(Habitattype == "2330_bu") 

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Polytrichum species, Dicranella species, Leptobryum species, Taraxacum Wiggers sectie Subvulgaria Christians., Pohlia species, Eurhynchium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 1547090_2017-07-13 zijn in de moslaag de synoniemen 'Dicranella species' en 'Leptobryum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 177078_2014-09-10 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 225910_2014-09-23 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 714230_2016-09-28 zijn in de moslaag de synoniemen 'Eurhynchium species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossen geen impact op LSVI
--> 1 record met Taraxacum Wiggers sectie Subvulgaria Christians. --> geen impact op LSVI

## TEST 2330_dw

```{r}
data_habitat_test_type <- data_habitat_fs %>%
  filter(Habitattype == "2330_dw") 

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

#check voorwaarde éénjarigen

soorten_enkelkruid <- data_soorten_kenm_fs %>%
  filter(Vegetatielaag == "kruidlaag" | is.na(Vegetatielaag))

test_eenj <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = soorten_enkelkruid %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID")) 

test_eenj <- test_eenj$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore) %>%
  filter(Indicator == "éénjarigen") 

compare_eenj <- test %>%
  select(ID, Habitattype, Indicator, Referentiewaarde, Waarde, Status_voorwaarde) %>%
  filter(Indicator == "éénjarigen") %>%
  left_join(select(test_eenj, ID, Habitattype, Indicator, Referentiewaarde, Waarde, Status_voorwaarde), 
            by = c("ID", "Habitattype", "Indicator"),
            suffix = c("_orig", "_corr"))
```

Aandeel meerjarige kruiden wordt berekend als de som van de bedekking van alles soorten exclusief éénjarigen; dus bedekking van bomen en mos worden ook meegrekend. 
Maar zou enkel kruidachtigen moeten zijn. 
De voorwaarde éénjarigen daarom opnieuw berekenen met enkel de soorten uit de kruidlaag en 'open zand'.

Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species.  Check de spelling en/of laat de auteursnaam weg bij genera.
  --> OK

## TEST 4010

```{r}
data_habitat_test_type <- data_habitat_fs %>%
  filter(Habitattype == "4010") %>%
  filter(ID == "23538_2022-09-01")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Sphagnum species, Dicranella species, Hypnum species, Sphagnum magellanicum Brid..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 120110_2014-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2015-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2019-08-21 zijn in de struiklaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)

Sphagnum magellanicum Brid. --> geen sleutelsoort
13 anb-plots met Sphagnum species --> worden niet meegerekend als sleutelsoort

## TEST 4030

```{r}
data_habitat_test_type <- data_habitat_fs %>%
  filter(Habitattype == "4030")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Hypnum species, Polytrichum species, Fontinalis species, Pseudoscleropodium species, Sphagnum species, Taraxacum Wiggers sectie Subvulgaria Christians., Bryum species, ANDERE SOORT.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 21430_2014-09-09 zijn in de moslaag de synoniemen 'Dicranella species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 42934_2014-09-10 zijn in de moslaag de synoniemen 'Fontinalis species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
  
--> Niet herkende soorten hebben geen impact op LSVI

## LSVI-berekening

```{r}

input_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/heath_inland_dunes/input") 

data_voorwaarden_fs  <- data_voorwaarden_fs  %>%
  filter(!(is.na(Waarde) & (Type == "Ja/nee")))

write_vc(data_voorwaarden_fs , file = "data_voorwaarden_fs ", root = input_path, 
         sorting = c("ID", "Voorwaarde"))
write_vc(data_habitat_fs, file = "data_habitat_fs ", root = input_path, 
         sorting = c("ID", "Habitattype"))
write_vc(data_soorten_kenm_fs, file = "data_soorten_kenm_fs ", root = input_path, 
         sorting = c("ID", "Vegetatielaag", "Kenmerk"))

lsvi_fs  <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_fs ,
                         Data_voorwaarden = data_voorwaarden_fs ,
                         Data_soortenKenmerken = data_soorten_kenm_fs ,
                         na.rm = TRUE)

```

### Manuele correctie

We berekenen de indicator 'éénjarigen' bij 2330_dw opnieuw, maar deze keer enkel met soorten uit de kruidlaag.

```{r}

data_habitat_2330_dw <- data_habitat_fs %>%
  filter(Habitattype == "2330_dw")

lsvi_eenjarigen <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_2330_dw ,
                         Data_voorwaarden = data_voorwaarden_fs %>%
                           semi_join(data_habitat_2330_dw, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_fs %>%
                           semi_join(data_habitat_2330_dw, by = "ID") %>%
                           filter(Vegetatielaag == "kruidlaag" | is.na(Vegetatielaag)),
                         na.rm = TRUE)

lsvi_eenjarigen_vw <- lsvi_eenjarigen$Resultaat_detail %>%
  filter(Indicator == "éénjarigen")

lsvi_eenjarigen_ind <- lsvi_eenjarigen$Resultaat_indicator %>%
  filter(Indicator == "éénjarigen")

lsvi_fs$Resultaat_detail <- lsvi_fs$Resultaat_detail %>%
  anti_join(lsvi_eenjarigen_vw, by = c("ID", "Indicator")) %>%
  bind_rows(lsvi_eenjarigen_vw) %>%
  arrange(ID, Habitattype, Criterium, Indicator)

lsvi_fs$Resultaat_indicator <- lsvi_fs$Resultaat_indicator %>%
  anti_join(lsvi_eenjarigen_ind, by = c("ID", "Indicator")) %>%
  bind_rows(lsvi_eenjarigen_ind) %>%
  arrange(ID, Habitattype, Criterium, Indicator)

correct_status_globaal <- lsvi_fs$Resultaat_indicator %>%
  filter(!is.na(Status_indicator)) %>%
  group_by(ID, Criterium) %>%
  mutate(weight_crit = 1/n()) %>%
  ungroup() %>%
  group_by(ID, Habitattype) %>%
  summarise(n_gunstig = sum(Status_indicator),
            n_ind = n_distinct(Indicator),
            n_zb_ongunstig = sum(Status_indicator == FALSE & Belang == "zb"),
            aandeel_gunstig = n_gunstig / n_ind * 100,
            status_habitatvlek =  n_zb_ongunstig == 0 & aandeel_gunstig > 50,
            index_mean_ind = round(mean(Verschilscore), 6),
            index_mean_crit = round(sum(weight_crit * Verschilscore) / sum(weight_crit), 6)
            ) %>%
  ungroup() %>%
  select(ID, Habitattype, n_zb_ongunstig, aandeel_gunstig, status_habitatvlek, index_mean_ind, index_mean_crit)

correct_status_criterium <- lsvi_fs$Resultaat_indicator %>%
  filter(!is.na(Status_indicator)) %>%
  group_by(ID, Habitattype, Criterium) %>%
  summarise(n_gunstig = sum(Status_indicator),
            n_ind = n_distinct(Indicator),
            n_zb_ongunstig = sum(Status_indicator == FALSE & Belang == "zb"),
            aandeel_gunstig = n_gunstig / n_ind * 100,
            status_criterium =  n_zb_ongunstig == 0 & aandeel_gunstig > 50,
            index_mean_ind = round(mean(Verschilscore), 6)
            ) %>%
  ungroup() %>%
  select(ID, Habitattype, Criterium, n_zb_ongunstig, aandeel_gunstig, status_criterium, index_mean_ind)

lsvi_fs$Resultaat_globaal <- lsvi_fs$Resultaat_globaal %>%
  left_join(correct_status_globaal, by = c("ID", "Habitattype")) %>%
  mutate(Status = status_habitatvlek) %>%
  select(-status_habitatvlek)

lsvi_fs$Resultaat_criterium <- lsvi_fs$Resultaat_criterium %>%
  left_join(correct_status_criterium, by = c("ID", "Habitattype", "Criterium")) %>%
  mutate(Status_criterium = status_criterium) %>%
  select(-status_criterium)

```






### Check missing voorwaarden

```{r}
missing_voorwaarde <- lsvi_fs$Resultaat_detail %>%
  group_by(Habitattype, Voorwaarde) %>%
  mutate(n_totaal = n()) %>%
  ungroup() %>%
  filter(is.na(Waarde)) %>%
  group_by(Habitattype, Voorwaarde, Belang, n_totaal) %>%
  summarise(n_missing = n(),
            plots_missing = str_c(ID, collapse = "; ")) %>%
  ungroup() %>%
  mutate(plots_missing = ifelse(n_missing < n_totaal,
                                plots_missing, ""))
```

```{r}
missing_voorwaarde %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Check missing belang

```{r}
missing_belang <- lsvi_fs$Resultaat_detail %>%
  filter(is.na(Belang)) %>%
  distinct(Habitattype, Voorwaarde, Belang)
```

```{r}
missing_belang %>%
  datatable(rownames = FALSE)
```

### Preview

```{r}
lsvi_fs$Resultaat_globaal %>%
  ggplot(aes(fill = Status, x = Habitattype)) +
  geom_bar()
```

```{r}
lsvi_fs$Resultaat_criterium %>%
  ggplot(aes(fill = Status_criterium, x = Criterium)) +
  geom_bar() +
  facet_wrap(~Habitattype) +
  coord_flip()
```

```{r, fig.width=9}
lsvi_fs$Resultaat_indicator %>%
  ggplot(aes(fill = Status_indicator, x = Indicator)) +
  geom_bar() +
  facet_wrap(~Habitattype, scales = "free", ncol = 2) +
  coord_flip()
```

## Write result

```{r}

output_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/heath_inland_dunes/result") 

lsvi_fs %>%
  write_lsvi_results(path = output_path, suffix = "_fs")
```

