---
title: "LSVI calculation"
output: html_document
date: "2024-06-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(git2rdata)
library(LSVI)
library(n2khab)
library(n2khabmon)
library(sf)
library(leaflet)
library(DT)

source("functions_lsvi_calc.R")
maakConnectiePool()
```

# Overview of MHQ schemes

```{r}

types <- read_types()

schemes <- read_schemes()

scheme_types <- read_scheme_types()

mhq_schemes <- schemes %>%
  filter(programme == "MHQ") %>%
  select(programme, scheme) %>%
  left_join(select(scheme_types, scheme, type), by = "scheme") %>%
  left_join(select(types, type, typeclass), by = "type")
```

```{r}
mhq_schemes %>%
  datatable(rownames = FALSE,
            filter = "top")
```


# Raw data

## INBOVEG data

```{r}
path_mhq_terr <- file.path(fileman_up("n2khab-mhq-data"), "processed/inboveg_mhq_terr")

path_mhq_terr_raw <- file.path(fileman_up("n2khab-mhq-data"), "raw/structure_variables")

classif_mhq_inbo <- get_type_inboveg(path_mhq_terr)

header_mhq_inbo <- get_header(path_mhq_terr)

```

## Fieldmap data

```{r}

path_mhq_anb <- file.path(fileman_up("n2khab-mhq-data"), "processed/fieldmap_mhq")

classif_mhq_anb <- read_vc(root = path_mhq_anb, file = "type_observed")
structure_mhq_anb <- read_vc(root = path_mhq_anb, file = "structure_vars")
vegetation_mhq_anb <- read_vc(root = path_mhq_anb, file = "cover_species")
veglayers_mhq_anb <- get_cover_veglayers_fieldmap(path_mhq_anb)

pq_mhq_anb <- classif_mhq_anb %>%
  distinct(date_assessment, plot_id) %>%
  semi_join(vegetation_mhq_anb, by = c("plot_id", "date_assessment"))
```

## Merge ANB and INBO data

```{r}

pq_mhq_inbo <- header_mhq_inbo %>%
  filter(!survey %in% c("Schelde-estuarium", "N2000meetnet_Bos_91E0_sf")) %>%
  mutate(plot_type = ifelse(area == 9, "square",
                            ifelse(area > 1000, "circle", NA)),
         date = as.Date(vague_date_begin)) %>%
  select(survey, date, record_id, user_reference, plot_type)

pq_mhq_inbo_wide <- pq_mhq_inbo %>%
  filter(!is.na(plot_type)) %>%
  pivot_wider(names_from = "plot_type", values_from = "record_id", names_prefix = "record_id_") %>%
  mutate(ID = str_c(user_reference, "_", date))

classif_mhq_inbo <- classif_mhq_inbo %>%
  filter(!survey %in% c("Schelde-estuarium", "N2000meetnet_Bos_91E0_sf")) %>%
  left_join(select(pq_mhq_inbo, record_id, plot_type), by = "record_id") %>%
  filter(plot_type == "square") %>%
  rename(record_id_square = record_id) %>%
  left_join(pq_mhq_inbo_wide, by = c("survey", "record_id_square"))

pq_mhq_anb <- pq_mhq_anb %>%
  mutate(ID = str_c(plot_id, "_", date_assessment),
         survey = "anb") %>%
  select(survey, date = date_assessment, ID) %>%
  mutate(record_id_square = ID,
         record_id_circle = ID)
  
classif_mhq_anb <- classif_mhq_anb %>%
  filter(segment_id == 1) %>%
  mutate(type_observed = ifelse(!is.na(type_observed_square), type_observed_square, type_observed_circle),
         ID = str_c(plot_id, "_", date_assessment),
         plot_type = "square",
         survey = "anb") %>%
  select(ID, survey, type_observed, plot_type) %>%
  inner_join(pq_mhq_anb, by = c("survey", "ID"))

type_info <- types %>%
  group_by(main_type) %>%
  mutate(has_subtypes = any(typelevel == "subtype")) %>%
  ungroup() %>%
  select(type_observed = type, typelevel, has_subtypes)

classif_mhq <- classif_mhq_inbo %>%
  bind_rows(classif_mhq_anb) %>%
  select(survey, ID, record_id_square, record_id_circle, date, type_observed, plot_type, type_cover) %>%
  left_join(type_info, by = "type_observed") %>%
  mutate(is_type_target = type_observed %in% mhq_schemes$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(mhq_schemes$type, 1, 4),
         subtype_defined = !(has_subtypes & typelevel == "main_type")) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         type_cover_all = str_c(str_c(type_cover, "% ", type_observed), collapse = "; ")) %>%
  ungroup() %>%
  filter(is_maintype_target)

data_habitat <- classif_mhq %>%
  select(ID, survey, record_id_square, record_id_circle, date, type_observed, subtype_defined, type_cover, type_cover_all)
  
```


# Grasland and marsh habitats

```{r}

schemes_gr_bm <- mhq_schemes %>%
  filter(typeclass %in% c("GR", "BMF", "CH")) %>%
  filter(type != "1330_da")

```

```{r}
schemes_gr_bm %>%
  datatable(rownames = FALSE,
            filter = "top")
  
```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_gr_bm$type),
                            Versie = "Versie 3") 
```


```{r}
overzicht_lsvi %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde) %>%
  datatable(rownames = FALSE,
            filter = "top")
```

## Invoergegevens

```{r}

data_habitat_gr_bm <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_gr_bm$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_gr_bm$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "6410", "6410_mo",
                              type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target) %>%
  filter(!type_observed %in% c("1330_da", "1330_pol"))

check <- data_habitat_gr_bm %>%
  group_by(ID) %>%
  filter(n() > 1)

voorwaarden_circle <- get_voorwaarden_gr_bm(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                                            data_path_extravar = path_mhq_terr_raw,
              record_ids = c(data_habitat_gr_bm$record_id_circle)) %>%
  filter(Indicator %in% c("verbossing", "structuurschade", "microreliëf", "strooisellaag")) %>%
  mutate(plot_type = "circle")

voorwaarden_square <- get_voorwaarden_gr_bm(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                                            data_path_extravar = path_mhq_terr_raw,
              record_ids = data_habitat_gr_bm$record_id_square) %>%
  filter(Indicator %in% c("strooisellaag")) %>%
  mutate(plot_type = "square")

data_voorwaarden_gr_bm <- voorwaarden_circle %>%
  bind_rows(voorwaarden_square)

check <- data_voorwaarden_gr_bm %>%
  group_by(ID, plot_type, Voorwaarde) %>%
  filter(n() > 1)

data_soorten_kenm_gr_bm <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                          record_ids = data_habitat_gr_bm$record_id_square)  %>%
                           mutate(Kenmerk = ifelse(str_detect(Kenmerk, "Taraxacum Wiggers"),
                                                              "Taraxacum", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Sphagnum magellanicum"),
                                                              "Sphagnum magellanicum Brid. s.l.", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Warnstorfia fluitans"),
                                                              "Warnstorfia", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Drepanocladus aduncus"),
                                                              "Drepanocladus", Kenmerk))

check <- data_soorten_kenm_gr_bm %>%
  group_by(ID, Kenmerk, Waarde, Vegetatielaag) %>%
  filter(n() > 1)
```

## Volledigheid van de invoergegevens

### Specificatie Habitatsubtype

+ 6410: we veronderstellen 6410_mo (lsvi berekening is identiek aan 6410_ve)
+ 6510: we berekenen lsvi voor elk subtype 

```{r}

subtypes_6510 <- types %>%
  filter(main_type == "6510") %>%
  filter(typelevel == "subtype") %>%
  select(type_observed = main_type, Habitattype = type) 

data_habitat_6510 <- data_habitat_gr_bm %>%
  filter(type_observed == "6510") %>%
  select(-Habitattype) %>%
  left_join(subtypes_6510, by = "type_observed")

data_habitat_gr_bm <- data_habitat_gr_bm %>%
  anti_join(data_habitat_6510, by = "ID") %>%
  bind_rows(data_habitat_6510)
```

### Voorwaarden

+ Structuurschade 
+ Verbossing
+ Strooisellaag
+ Microreliëf

```{r}
voorwaarden_grl_bm <- overzicht_lsvi %>%
  filter(Indicator %in% c("structuurschade", "verbossing", "strooisellaag", "microreliëf")) %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) 

indicator_plot_type <- data_voorwaarden_gr_bm %>%
  distinct(Indicator, plot_type)

check_voorwaarden <- data_habitat_gr_bm %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_grl_bm, by = "Habitatsubtype") %>%
  left_join(indicator_plot_type, by = "Indicator") %>%
  left_join(data_voorwaarden_gr_bm, by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))
  
voorwaarden_waarde_missing <- check_voorwaarden %>%
  filter(is.na(Waarde)) %>%
  filter(Indicator != "strooisellaag") %>%
  select(record_id_square, record_id_circle, ID, date, type_observed, Indicator, Waarde)

check_strooisellaag <- check_voorwaarden %>%
  filter(Indicator == "strooisellaag") %>%
  distinct(survey, record_id_square, record_id_circle,  date, ID, plot_type, Indicator, Waarde) %>%
  pivot_wider(names_from = "plot_type",
              names_prefix = "cover_",
              values_from = "Waarde") %>%
  mutate(diff_status = (cover_circle <= 10) != (cover_square <= 10))

overzicht_strooisellaag <- check_strooisellaag %>%
  group_by(diff_status) %>%
  summarise(n = n()) %>%
  ungroup()

voorwaarden_waarde_missing %>%
  write_csv2("../../output/structuurschade_verbossing_missing.csv")

check_strooisellaag %>%
  write_csv2("../../output/strooisellaag_missing.csv")
```

Srooisellaag wordt vanaf 2022 uitsluitend in de vierkante plot bepaalt. 
We selecteren dus de waarde voor strooisellaag uit de vierkante plot.

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

```{r}
data_voorwaarden_gr_bm <- check_voorwaarden %>%
  filter(!(plot_type == "circle" & Indicator == "strooisellaag")) %>%
  mutate(Waarde = ifelse(Indicator == "strooisellaag",
                         ifelse(is.na(Waarde) & !is.na(record_id_square), 0, Waarde),
                         ifelse(is.na(Waarde) & !is.na(record_id_circle), 0, Waarde)),
         Type = "Percentage",
         Eenheid = "%",
         record_id = ifelse(plot_type == "square",
                                  record_id_square,
                                  record_id_circle)) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique()

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_gr_bm  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_gr_bm, by = c("record_id"))

check_missingvalue <- data_habitat_gr_bm  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_gr_bm, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_kenmerk %>%
  select(record_id, ID, Habitattype, Vegetatielaag, Kenmerk, Waarde) %>%
  write_csv2("../../output/check_vegopname.csv")

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_gr_bm %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)

data_soorten_kenm_gr_bm <- data_soorten_kenm_gr_bm %>%
  filter(!is.na(Kenmerk),
         !is.na(Waarde))
  
```
Ontbrekende soortnamen meestal mos spec.

### Uittesten LSVI-berkening en beoordeling van impact van warning op LSVI-berekening

#### TEST 1330_hpr

OK

```{r, eval = FALSE}
data_habitat_test <- data_habitat_gr_bm %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  filter(Habitattype != "1330_da")

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "1330_hpr") 

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Drepanocladus aduncus (Hedw.) Warnst..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in berekenLSVIbasis(Versie = "Versie 3", Kwaliteitsniveau = 1, Data_habitat = data_habitat_test_type,  :
  De waarde(n) voor de voorwaarde(n) differentiatie in zout- en tredplanten (VoorwaardeID 2152) kunnen niet berekend worden voor opname(n) 908981_2016-09-15, 455349_2015-08-03, 996353_2015-08-24, 472065_2015-08-24, 1117877_2015-08-20, 736949_2015-08-12, 212661_2015-08-13, 801793_2015-08-19, 540341_2015-08-14, 437685_2015-08-06, 37557_2015-08-11, 798133_2015-08-11, 695297_2015-08-19, 1348277_2017-09-29, 299701_2017-09-29, 1403657_2017-09-29, 1785525_2018-07-04, 1830581_2018-07-04, 1928193_2018-06-29, 1872565_2018-06-28, 1715637_2018-06-28, 1936821_2018-06-28, 1945013_2018-06-28, 1667357_2018-06-14, 1750129_2018-06-29, 1547265_2018-06-29, 1461001_2018-06-14, 2239241_1330_hpr_2019-10-29, 1498805_1330_hpr_2019-10-29, 1594037_1330_hpr_2019-10-29, 2364085_1330_hpr_2019-10-29, 2143233_1330_hpr_2019-10-17, 2333697_1330_hpr_2019-10-31, 2805181_2020-10-15, 3067325_2020-10-15, 2018749_2020-10-15, 2936253_2020-10-15, 3492617_2020-08-07, 2595841_2020-08-18, 3062785_2020-08-18, 3054593_2020-08-18, 165 [... truncated]

--> mossoort niet herkend --> geen impact op LSVI

#### TEST 6230_ha

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_ha")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_resultaat_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```

geen warnings

#### TEST 6230_hmo

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hmo")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
geen warnings

#### TEST 6230_hn

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hn")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6230_hnk

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hnk")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6410_mo

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6410_mo")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6410_ve

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6410_ve")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6510_hu

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hu")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Taraxacum Wiggers sectie Subvulgaria Christians., Dicranella species.  Check de spelling en/of laat de auteursnaam weg bij genera.

--> naam "Taraxacum Wiggers sectie Subvulgaria Christians." veranderen naar "Taraxacum"

#### TEST 6510_huk

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_huk")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6510_hus

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hus")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Criterium, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
geen warnings

#### TEST 6510_hua

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hua")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 7140_oli

belang 'veenmossen' ontbreekt --> moet zb zijn

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "7140_oli")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Sphagnum magellanicum Brid..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 1465330_2020-09-24 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 1470454_2021-08-18 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 1470454_2021-08-18 zijn in de struiklaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 170798_2023-10-16 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)

naam "Sphagnum magellanicum Brid." veranderen in "Sphagnum magellanicum Brid. s. l." 

#### TEST 7140_meso

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "7140_meso")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Warnstorfia fluitans (Hedw.) Loeske, Drepanocladus aduncus (Hedw.) Warnst..  Check de spelling en/of laat de auteursnaam weg bij genera.

--> Warnstorfia fluitans (Hedw.) Loeske veranderen naar Warnstorfia --> OK
--> Drepanocladus aduncus (Hedw.) Warnst. veranderen naar Drepanocladus --> OK

### LSVI-berekening

```{r}

input_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/gr_bm/input") 

write_vc(data_voorwaarden_gr_bm, file = "data_voorwaarden_gr_bm", root = input_path, 
         sorting = c("ID", "Voorwaarde"))
write_vc(data_habitat_gr_bm, file = "data_habitat_gr_bm", root = input_path, 
         sorting = c("ID", "Habitattype"))
write_vc(data_soorten_kenm_gr_bm, file = "data_soorten_kenm_gr_bm", root = input_path, 
         sorting = c("ID", "Vegetatielaag", "Kenmerk"))

lsvi_gr_bm <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_gr_bm,
                         Data_voorwaarden = data_voorwaarden_gr_bm,
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm,
                         na.rm = TRUE)

lsvi_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/gr_bm/result") 

write_lsvi_results(lsvi_gr_bm, path = lsvi_path, suffix = "_gr_bm")

```

```{r}
lsvi_gr_bm_globaal %>%
  ggplot(aes(fill = Status, x = Habitattype)) +
  geom_bar() +
  coord_flip()
```


# Dune habitat types

## Meetnetten
```{r}

schemes_cd <- mhq_schemes %>%
  filter(typeclass %in% c("CD")) 

```

```{r}
schemes_cd %>%
  datatable(rownames = FALSE,
            filter = "top")
```
## LSVI indicatoren

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_cd$type),
                            Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling)


overzicht_missing_belang <- geefInvoervereisten(Kwaliteitsniveau = 1,Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling, Belang) %>%
  filter(is.na(Belang))

write_csv2(overzicht_missing_belang, "../../output/missing_belang.csv")
```

```{r}
overzicht_lsvi %>%
  datatable(rownames = FALSE,
            filter = "top")
```


## Invoergegevens

```{r}

data_habitat_cd <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_cd$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_cd$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "2190", "2190_mp", type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target)

check <- data_habitat_cd %>%
  group_by(ID) %>%
  filter(n() > 1)

data_voorwaarden_cd <- get_voorwaarden_cd(data_path = path_mhq_terr,
                          record_ids = c(data_habitat_cd$record_id_square,
                                         data_habitat_cd$record_id_circle)) %>%
  left_join(select(pq_mhq_inbo, record_id, plot_type), by = "record_id") %>%
  mutate(plot_type = ifelse(!Voorwaarde %in% c("fijnmazige afwisseling", "bedekking alle mossen"), "circle", plot_type)) %>%
  unique()

data_soorten_kenm_cd <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                          record_ids = data_habitat_cd$record_id_square) 

check <- data_soorten_kenm_cd %>%
  group_by(ID, Kenmerk, Waarde, Vegetatielaag) %>%
  filter(n() > 1)
```

```{r}
data_habitat_test <- data_habitat_cd %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup()
```

## Berkening voorwaarden

Volgende voorwaarden worden rechtstreeks ingeschat op terrein:

+ bedekking rijshout (2120)
+ open plekken aanwezig (2160)
+ bedekking structuurverstoring (2120)

Volgende voorwaarden worden afgeleid uit de meetvariabelen:

+ fijnmazige afwisseling (2120): we beschouwen deze voorwaarde als gunstig indien zowel helm als open zand aanwezig zijn.
+ spontane verstuiving (2120): binnen de cirkelplot wordt de bedekking geschat van volgende categorieën: beperkte verstuiving, sterke verstuiving en gefixeerd. Spontane verstuiving beschouwen we als gunstig wanneer de som van de 'beperkte verstuiving' en 'sterke verstuiving' groter is dan 0% (of 30% ??).
+ bedekking alle mossen (2120): hier moeten we de bedekking berekenen t.o.v. het begroeide deel van de duin. Het begroeide deel van de duin bepalen we als 100% min de bedekking van naakte bodem.
+ aantal struweelsoorten (2160): op basis van de bedekking van de struweeltypes pionier, ontwikkeling, climax en degeneratie bepalen we het aantal aanwezige struweelsoorten.

De voorwaarde 'naakte bodem' van habitattype 2120 wordt niet bepaald.

Voor habitattype 2180 zijn er geen dendrometrische gegevens en kunnen enkel de voorwaarden die af te leiden zijn uit de kruidlaaggegevens bepaald worden.

## Volledigheid van de invoergegevens

### Specifiactie habitatsubtype

+ 2130: we berkenen lsvi voor beide subtypes
+ 2190_overige: we berekenen lsvi voor subtype 2190_mp (er is enkel beoordelingstabel voor 2190_mp) 

```{r}

subtypes_2130 <- types %>%
  filter(main_type == "2130") %>%
  filter(typelevel == "subtype") %>%
  select(type_observed = main_type, Habitattype = type) 

data_habitat_2130 <- data_habitat_cd %>%
  filter(type_observed == "2130") %>%
  select(-Habitattype) %>%
  left_join(subtypes_2130, by = "type_observed")

data_habitat_cd <- data_habitat_cd %>%
  anti_join(data_habitat_2130, by = "ID") %>%
  bind_rows(data_habitat_2130)
```

### Voorwaarden

```{r}
voorwaarden_cd <- overzicht_lsvi %>%
  semi_join(data_voorwaarden_cd, by = "Voorwaarde") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) 

# fijnmazige afwisseling kunnen zowel in vierkant als cirkelplot worden ingeschat, alle andere voorwaarde enkel in cirkelplot bepaald
voorwaarde_plot_type <- data_voorwaarden_cd %>%
  distinct(Voorwaarde, plot_type, Eenheid, Type) %>%
  filter(!((Voorwaarde %in% c("fijnmazige afwisseling", "bedekking alle mossen")) & (plot_type ==  "circle")))

check_voorwaarden <- data_habitat_cd %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_cd, by = "Habitatsubtype") %>%
  left_join(voorwaarde_plot_type, by = "Voorwaarde") %>%
  left_join(select(data_voorwaarden_cd, -Eenheid, -Type), by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))

check_hs_2160 <- check_voorwaarden %>%
  filter(Voorwaarde %in% c("open plekken aanwezig", "aantal struweelsoorten")) 

open_plek_square <- get_cover_veglayers(data_path = path_mhq_terr, record_ids = open_plek_circle$record_id_square) %>%
  filter(layer_code %in% c("NB")) %>%
  rename(record_id_square = recording_givid) %>%
  select(record_id_square, cover_square = cover)

check_open_plek <- open_plek_circle %>%
  left_join(open_plek_square, by = "record_id_square") 

duindoorn_aanwezig <- data_soorten_kenm_cd %>%
  group_by(ID) %>%
  filter(Kenmerk == "Hippophae rhamnoides L.") %>%
  summarise(dunidoorn_bedekking = str_c(str_c(Vegetatielaag, ": ", Waarde), collapse = "; ")) %>%
  ungroup()
              

voorwaarden_waarde_missing <- check_voorwaarden %>%
  filter(is.na(Waarde)) %>%
  filter(Voorwaarde != "open plekken aanwezig") %>%
  filter(!(Voorwaarde == "fijnmazige afwisseling" & plot_type == "circle")) %>%
  select(ID, record_id_square, record_id_circle, type_observed, type_cover_all, date, Habitatsubtype, Indicator, Voorwaarde, Waarde) %>%
  left_join(duindoorn_aanwezig, by = "ID")

voorwaarden_waarde_missing %>%
  filter(Voorwaarde != "aantal struweelsoorten") %>%
  write_csv2("../../output/cd_indicatoren_missing.csv")

voorwaarden_waarde_missing %>%
  filter(Voorwaarde == "aantal struweelsoorten") %>%
  write_csv2("../../output/struweelsoorten_missing.csv")

check_open_plek %>%
  filter(is.na(Waarde)) %>%
  filter(type_cover_all == "100% 2160") %>%
  select(record_id_square, record_id_circle, type_observed, Indicator, Voorwaarde, Waarde, naakte_bodem_square = cover_square) %>%
  write_csv2("../../output/cd_open_plek_missing.csv")

hs_missing <- check_hs_2160 %>%
  select(ID, type_cover_all, Voorwaarde, Waarde) %>%
  pivot_wider(names_from = Voorwaarde, values_from = Waarde) %>%
  filter(is.na(`aantal struweelsoorten`) | is.na(`open plekken aanwezig`)) %>%
  filter(type_cover_all == "100% 2160")
 
hs_missing %>%
  write_csv2("../../output/2160_hs_missing.csv")

```

Voor de voorwaarden bedekking rijshout, bedekking alle mossen, bedekking structuurverstoring veronderstellen we dat de ontbrekende waarden = 0 indien er een opname in inboveg zit.

De indicator horizontale structuur voor 2160 bestaat uit twee voorwaarden

+ Voorwaarde aantal struweelsoorten: indien geen enkele bedekking is ingevuld voor een van de struweeltypes dan is het aantal struweelsoorten onbekend (=NA)
+ Voorwaarde open plekken aanwezig: indien er geen bedekking is ingevuld voor 'open plekken' maar er is wel een bedekking ingevuld voor een van de struweeltypes dan veronderstellen we 0% bedekking voor 'open plekken'

Voorwaarde spontane verstuiving: indien geen enkele bedekking is ingevuld voor een van de verstuivingsklassen:
+ kijken naar aanwezigheid naakte bodem

```{r}

hs_missing_corrected <- hs_missing %>%
  mutate(`open plekken aanwezig` = ifelse(is.na(`open plekken aanwezig`) & !is.na(`aantal struweelsoorten`),
                                          0,
                                          `open plekken aanwezig`)) %>%
  pivot_longer(cols = c(`open plekken aanwezig`, `aantal struweelsoorten`), 
               names_to = "Voorwaarde",
               values_to = "Waarde") %>%
  select(-type_cover_all)
 
data_hs_2160 <- check_hs_2160 %>%
  select(-Waarde) %>%
  inner_join(hs_missing_corrected, by = c("ID", "Voorwaarde"))

data_voorwaarden_cd <- check_voorwaarden %>%
  filter(!((plot_type == "circle") & (Voorwaarde == "fijnmazige afwisseling"))) %>%
  mutate(Waarde = ifelse(is.na(Waarde) & Voorwaarde %in% c("bedekking rijshout", "bedekking alle mossen", "bedekking structuurverstoring") ,
                         0, Waarde)) %>%
  anti_join(data_hs_2160, by = c("ID", "Voorwaarde")) %>%
  bind_rows(data_hs_2160) %>%
  mutate(record_id = ifelse(plot_type == "square",
                                  record_id_square,
                                  ifelse(!is.na(record_id_circle), 
                                         record_id_circle, record_id_square))) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique()

data_soorten_kenm_cd <- data_soorten_kenm_cd %>%
  filter(!is.na(Kenmerk))

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_cd  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_cd, by = c("record_id"))

check_missingvalue <- data_habitat_cd  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_cd, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_kenmerk %>%
  select( ID, Habitattype, Vegetatielaag, Kenmerk, Waarde) %>%
  write_csv2("../../output/cd_check_vegopname.csv")

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_cd %>%
  filter(!is.na(Kenmerk)) %>%
  group_by(ID, record_id,  Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)
 
data_soorten_kenm_cd <- data_soorten_kenm_cd %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(Waarde == max(Waarde)) %>%
  ungroup() %>%
  unique()
 
```

De meetpunten 10578737_2120 (2018-09-27), 10342193_2120 (2019-10-15) en 3807153_2120 (2020-08-24) bestaan voor 100% naakte bodem in vierkante plot --> indien geen vegetatie NA voor sleutelsoorten en horizontale structuur. De rekenmodule geeft sowieso NA als vegetatiegegevens ontbreken, ook voor exoten, vergrassing,...

601649_2021-08-17 -> gegevens vegopname ontbreekt want 4 struweelsoorten aanwezig --> plot verwijderen

Soms komen dezelfde soorten meerdere keren voor in vegopname in zelfde laag. Maar dat is dan één keer als kiemplant.
Dit LSVI-rekenmodule geeft hiervoor een error. We selecteren per meetpunt, soort en vegetatielaag de maximale bedekking.

### Aanpassingen berekeningen rekenmodule

#### Onvolledige opname verwijderen

```{r}
data_voorwaarden_cd <- data_voorwaarden_cd %>%
  filter(ID != "601649_2021-08-17")

data_habitat_cd <- data_habitat_cd %>%
  filter(ID != "601649_2021-08-17")
```

#### Vegetatieloze plots voor 2120

```{r}

meetpunten_no_veg <- missing_cover %>%
  filter(Habitattype == "2120") %>%
  select(ID, record_id, Habitattype)

voorwaarden_2120_corrected_1 <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = "2120",
                            Versie = "Versie 3") %>%
  filter(Habitatsubtype == "2120") %>%
  filter(!is.na(TaxongroepId)) %>%
  filter(Voorwaarde != "bedekking alle mossen") %>%
  left_join(meetpunten_no_veg, by = "Habitattype") %>%
  select(ID, record_id, Criterium, Indicator, Voorwaarde, Eenheid, Type = TypeVariabele) %>%
  mutate(Invoertype = NA,
         Waarde = 0,
         plot_type = "square")


```

De meetpunten 10578737_2120 (2018-09-27), 10342193_2120 (2019-10-15) en 3807153_2120 (2020-08-24) bestaan voor 100% naakte bodem.

De rekenmodule geeft een ontbrekende waarde voor de voorwaarden afgeleid uit de soortensamenstelling.
We stellen de waardes gelijk aan 0 en voegen dit in de rekenmodule in via 'data_voorwaarden'.

```{r}
voorwaarden_2120_corrected_1 %>%
  distinct( Criterium, Indicator, Voorwaarde) %>%
  datatable(rownames = FALSE)
```

#### Bedekkingen relatief tot begroeide deel van de duin voor 2120

Voorde meeste voorwaarden bij 2120 moet de bedekking relatief t.o.v. het begroeide deel van de duin beschouwd worden.
De rekenmodule berekent de totale bedekking per voorwaarde.
Deze totale bedekking moet dus nog eens gedeeld worden door de de bedekking van het begroeide deel (= 1 - bedekking naakte bodem).
We kunnen dit enkel doen voor de voorwaarden die op basis van de vierkante plot ingeschat kunnen worden, want enkel voor de vierkante plot is de bedekking van naakte bodem bepaald.
Voor structuurverstoring kunnen we de relatieve bedekking t.o.v. het begroeide deel niet bepalen en gebruiken we dus de totale bedekking.

Voor volgende variabelen voeren we de correctie uit:

+ bedekking soorten pionierduingrasland
+ bedekking verruiging
+ bedekking overige exoten
+ bedekking vergrassing

Wat met plots met zeer lage bedekking vegetatie?

```{r}

data_habitat_2120 <- data_habitat_cd %>%
  filter(Habitattype == "2120") %>%
  anti_join(voorwaarden_2120_correct, by = "ID") #de vegetatieloze plots

lsvi_temp <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_2120,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_2120, by = "ID")) 

voorwaarden_2120_bedekking  <- lsvi_temp$Resultaat_detail %>%
  filter(Voorwaarde %in% c("bedekking soorten pionierduingrasland",
                           "bedekking verruiging",
                           "bedekking overige exoten",
                           "bedekking vergrassing"))

cover_veg <- get_cover_veglayers(data_path = path_mhq_terr, 
                                          record_ids = voorwaarden_2120_bedekking$record_id_square) %>%
  select(-layer_description) %>%
  pivot_wider(names_from = layer_code, values_from = cover, names_prefix = "cover_", values_fill = 0) %>%
  mutate(cover_veg = pmax(cover_K, 100 - cover_NB)) %>%
  select(record_id_square = recording_givid,cover_veg)

voorwaarden_2120_bedekking_correct <- voorwaarden_2120_bedekking %>%
  left_join(cover_veg, by = "record_id_square") %>%
  mutate(Waarde_corr = pmin(100, as.numeric(Waarde) / cover_veg * 100),
         Status_voorwaarde_corr = Waarde_corr <= as.numeric(Referentiewaarde)) %>%
  select(ID, record_id = record_id_square, Criterium, Indicator, Voorwaarde, Belang, Waarde_orig = Waarde, cover_veg, Waarde_corr, Referentiewaarde, Status_voorwaarde, Status_voorwaarde_corr, Eenheid = EenheidWaarde, Type = TypeWaarde)
```


```{r}
voorwaarden_2120_bedekking_correct %>%
  select(-Status_voorwaarde, -Status_voorwaarde_corr) %>%
  mutate(Waarde_orig = as.numeric(Waarde_orig),
         Referentiewaarde = as.numeric(Referentiewaarde)) %>%
  pivot_longer(cols = c("Waarde_orig", "Waarde_corr"), names_to = "type", values_to = "Waarde") %>%
  mutate(Status = ifelse(Waarde <= Referentiewaarde, "gunstig", "ongunstig"),
         show_facet = str_c(Voorwaarde, " (", Belang, ")")) %>%
  ggplot(aes(x = type, fill = Status)) +
  geom_bar() +
  facet_wrap(~show_facet)
  
```

```{r}
voorwaarden_2120_bedekking_correct %>%
  select(-Status_voorwaarde, -Status_voorwaarde_corr) %>%
  mutate(Waarde_orig = as.numeric(Waarde_orig),
         Referentiewaarde = as.numeric(Referentiewaarde)) %>%
  pivot_longer(cols = c("Waarde_orig", "Waarde_corr"), names_to = "type", values_to = "Waarde") %>%
  mutate(Status = ifelse(Waarde <= Referentiewaarde, "gunstig", "ongunstig"),
         show_facet = str_c(Voorwaarde, " (", Belang, ")")) %>%
  ggplot(aes(x = cover_veg, fill = Status)) +
  geom_histogram(binwidth = 10) +
  facet_grid(type~show_facet)
```



```{r}
voorwaarden_2120_corrected_2 <- voorwaarden_2120_bedekking_correct %>%
  select(ID, record_id, Criterium, Indicator, Voorwaarde, Waarde = Waarde_corr, Eenheid, Type) %>%
  mutate(Invoertype = NA,
         plot_type = "square"
         )
```

```{r}
data_voorwaarden_cd <- data_voorwaarden_cd %>%
  anti_join(voorwaarden_2120_corrected_2, by = c("ID", "Voorwaarde")) %>%
  anti_join(voorwaarden_2120_corrected_1, by = c("ID", "Voorwaarde")) %>%
  bind_rows(voorwaarden_2120_corrected_1,
            voorwaarden_2120_corrected_2) %>%
  arrange(ID, Voorwaarde)
```

#### Grondvlak sleutelsoorten in boom- en struiklaag 2180

We hebben geen gegevens over het grondvlak van de boomsoorten voor de meetpunten van 2180.
De rekenmodule geeft daarom steeds een 0 voor de voorwaarde
Dit moet een onbrekende waarde zijn.
We geven de NA's expliciet in via data_voorwaarden.

```{r}
data_vw_sleutelsoorten_2180 <- data_habitat_cd %>%
  filter(Habitattype == "2180") %>%
  select(ID, record_id = record_id_circle) %>%
  mutate(plot_type = "circle",
         Criterium = "Vegetatie",
         Indicator = "sleutelsoorten van de boom- en struiklaag",
         Voorwaarde = "grondvlak sleutelsoorten boom- en struiklaag",
         Waarde = NA,
         Type = "Percentage",
         Eenheid = "%",
         Invoertype = NA)

data_voorwaarden_cd <- data_voorwaarden_cd %>%
  bind_rows(data_vw_sleutelsoorten_2180)
```



## TEST 2120

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2120")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_cd %>%
                           semi_join(data_habitat_test_type, by = "ID") %>%
                           filter(!(is.na(Waarde) & (Type == "Ja/nee"))))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
OK

## TEST 2130_hd

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2130_hd")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

OK

## TEST 2130_had

OK

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2130_had")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

OK

## TEST 2160


```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2160")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

OK

## TEST 2170

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2170")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

## TEST 2180

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2180")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

Grondvlak sleutelsoorten geeft steeds 0 als uitkomst, maar moet NA zijn.

## TEST 2190_mp

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2190_mp")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

OK

## LSVI-berekening

```{r}

input_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/coastal_dunes/input") 

data_voorwaarden_cd <- data_voorwaarden_cd %>%
  filter(!(is.na(Waarde) & (Type == "Ja/nee")))

write_vc(data_voorwaarden_cd, file = "data_voorwaarden_cd", root = input_path, 
         sorting = c("ID", "Voorwaarde"))
write_vc(data_habitat_cd, file = "data_habitat_cd", root = input_path, 
         sorting = c("ID", "Habitattype"))
write_vc(data_soorten_kenm_cd, file = "data_soorten_kenm_cd", root = input_path, 
         sorting = c("ID", "Vegetatielaag", "Kenmerk"))

lsvi_cd <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_cd,
                         Data_voorwaarden = data_voorwaarden_cd,
                         Data_soortenKenmerken = data_soorten_kenm_cd,
                         na.rm = TRUE)

```
### Check missing voorwaarden

```{r}
missing_voorwaarde <- lsvi_cd$Resultaat_detail %>%
  group_by(Habitattype, Voorwaarde) %>%
  mutate(n_totaal = n()) %>%
  ungroup() %>%
  filter(is.na(Waarde)) %>%
  group_by(Habitattype, Voorwaarde, Belang, n_totaal) %>%
  summarise(n_missing = n(),
            plots_missing = str_c(ID, collapse = "; ")) %>%
  ungroup() %>%
  mutate(plots_missing = ifelse(n_missing < n_totaal,
                                plots_missing, ""))
```
```{r}
missing_voorwaarde %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Check missing belang

```{r}
missing_belang <- lsvi_cd$Resultaat_detail %>%
  filter(is.na(Belang)) %>%
  distinct(Habitattype, Voorwaarde, Belang)
```

```{r}
missing_belang %>%
  datatable(rownames = FALSE)
```

### Manuele correctie

+ belang bedekking structuurverstoring toevoegen: b

```{r}
lsvi_cd$Resultaat_detail <- lsvi_cd$Resultaat_detail %>%
  mutate(Belang = ifelse(is.na(Belang) & Indicator == "structuurverstoring", "b", Belang))

lsvi_cd$Resultaat_indicator <- lsvi_cd$Resultaat_indicator  %>%
  mutate(Belang = ifelse(is.na(Belang) & Indicator == "structuurverstoring", "b", Belang))

correct_status_globaal <- lsvi_cd$Resultaat_indicator %>%
  group_by(ID, Habitattype) %>%
  filter(!is.na(Status_indicator)) %>%
  summarise(n_gunstig = sum(Status_indicator),
            n_ind = n_distinct(Indicator),
            n_zb_ongunstig = sum(Status_indicator == FALSE & Belang == "zb"),
            aandeel_gunstig = n_gunstig / n_ind * 100,
            status_habitatvlek =  n_zb_ongunstig == 0 & aandeel_gunstig > 50) %>%
  ungroup() %>%
  select(ID, Habitattype, n_zb_ongunstig, aandeel_gunstig, status_habitatvlek)

check <- lsvi_cd$Resultaat_globaal %>%
  left_join(correct_status_globaal, by = c("ID", "Habitattype")) %>%
  filter(Status != status_habitatvlek)

lsvi_cd$Resultaat_globaal <- lsvi_cd$Resultaat_globaal %>%
  left_join(correct_status_globaal, by = c("ID", "Habitattype")) %>%
  mutate(Status = status_habitatvlek) %>%
  select(-status_habitatvlek)
  
```

```{r}
lsvi_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/coastal_dunes/result") 

write_lsvi_results(lsvi_cd, path = lsvi_path, suffix = "lsvi_cd")
```

# Heath habitat types

```{r}

schemes_hs_id <- mhq_schemes %>%
  filter(typeclass %in% c("ID", "HS")) 

```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_hs_id$type),
                            Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling)

```

## Invoergegevens

```{r}

data_habitat_hs_id <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_hs_id$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_hs_id$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "6410", "6410_mo",
                              type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target) %>%
  filter(!str_detect(survey, "Grasland|Moeras"))

check <- data_habitat_hs_id %>%
  group_by(ID) %>%
  filter(n() > 1)

data_voorwaarden_hs_id <- get_voorwaarden_hs_id(data_path_fieldmap = path_mhq_anb,
                                                data_path_inboveg = path_mhq_terr,
                          record_ids = c(data_habitat_hs_id$record_id_square,
                                         data_habitat_hs_id$record_id_circle)) %>%
  mutate(plot_type = "circle")

data_soorten_kenm_hs_id <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                                                 data_path_fieldmap = path_mhq_anb,
                         record_ids =  data_habitat_hs_id$record_id_square) %>%
  bind_rows(get_kenmerken_open_zand(data_path_fieldmap = path_mhq_anb,
                                                data_path_inboveg = path_mhq_terr,
                          record_ids = c(data_habitat_hs_id$record_id_square,
                                         data_habitat_hs_id$record_id_circle)))

```

## Volledigheid van de invoergegevens

### Voorwaarden

```{r}
voorwaarden_hs_id  <- overzicht_lsvi %>%
  semi_join(data_voorwaarden_hs_id , by = "Voorwaarde") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) %>%
  mutate(Voorwaarde = ifelse(Habitatsubtype == "2310" & Indicator == "horizontale structuur", 
                             "bedekking open vegetaties en kaal zand", 
                             Voorwaarde))

voorwaarde_plot_type <- data_voorwaarden_hs_id  %>%
  distinct(Voorwaarde, plot_type, Eenheid, Type)

check_voorwaarden <- data_habitat_hs_id  %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_hs_id , by = "Habitatsubtype") %>%
  left_join(voorwaarde_plot_type, by = "Voorwaarde") %>%
  left_join(select(data_voorwaarden_hs_id , -Eenheid, -Type), by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))

voorwaarden_record_missing <- check_voorwaarden %>%
  filter(is.na(record_id)) %>%
  select(ID, record_id_square, record_id_circle, date, Habitatsubtype, Indicator, Voorwaarde, Waarde)

voorwaarden_waarde_missing %>%
  write_csv2("../../output/heide_indicatoren_missing.csv")

```

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

```{r}

data_voorwaarden_hs_id <- check_voorwaarden %>%
  mutate(Waarde = ifelse(is.na(Waarde) & !is.na(record_id), 0, Waarde)) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique() %>%
  mutate(Voorwaarde = ifelse(Voorwaarde == "bedekking open vegetaties en kaal zand",
                             "bedekking open vegetaties", Voorwaarde)) %>%
  unique()

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_hs_id  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_hs_id, by = c("record_id"))

check_missingvalue <- data_habitat_hs_id  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_hs_id, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_hs_id %>%
  filter(!is.na(Kenmerk)) %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)
  
data_soorten_kenm_hs_id <- data_soorten_kenm_hs_id %>%
  filter(!is.na(Kenmerk))
```

Ontbrekende soortnamen in kruidlaag --> Calluna dood, Erica dood
Ontbrekende soortnamen in korstmoslaag --> korstmos spec. 

geen impact op LSVI

Ontbrekende bedekking wel een probleem: sleutelsoorten moeten talrijk aanwezig zijn.

```{r}
data_habitat_test <- data_habitat_hs_id %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup()
```

## TEST 2310

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "2310")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Polytrichum species, Pseudoscleropodium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 476086_2014-09-04 zijn in de moslaag de synoniemen 'Polytrichum species' en 'Pseudoscleropodium species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossoorten --> heeft geen impact op LSVI --> OK


## TEST 2330_bu

```{r}
data_habitat_test_type <- data_habitat_hs_id%>%
  filter(Habitattype == "2330_bu")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Polytrichum species, Dicranella species, Leptobryum species, Taraxacum Wiggers sectie Subvulgaria Christians., Pohlia species, Eurhynchium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 1547090_2017-07-13 zijn in de moslaag de synoniemen 'Dicranella species' en 'Leptobryum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 177078_2014-09-10 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 225910_2014-09-23 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 714230_2016-09-28 zijn in de moslaag de synoniemen 'Eurhynchium species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossen geen impact op LSVI
--> 1 record met Taraxacum Wiggers sectie Subvulgaria Christians. --> geen impact op LSVI

## TEST 2330_dw

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "2330_dw")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```

Aandeel meerjarige kruiden wordt berekend als de som van de bedekking van alles soorten exclusief éénjarigen; dus bedekking van bomen wordt ook meegrekend: OK?

Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species.  Check de spelling en/of laat de auteursnaam weg bij genera.
  --> OK

## TEST 4010

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "4010")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Sphagnum species, Dicranella species, Hypnum species, Sphagnum magellanicum Brid..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 120110_2014-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2015-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2019-08-21 zijn in de struiklaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)

Sphagnum magellanicum Brid. --> geen sleutelsoort
13 anb-plots met Sphagnum species --> worden niet meegerekend als sleutelsoort

## TEST 4030

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "4030")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Hypnum species, Polytrichum species, Fontinalis species, Pseudoscleropodium species, Sphagnum species, Taraxacum Wiggers sectie Subvulgaria Christians., Bryum species, ANDERE SOORT.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 21430_2014-09-09 zijn in de moslaag de synoniemen 'Dicranella species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 42934_2014-09-10 zijn in de moslaag de synoniemen 'Fontinalis species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
  
--> Niet herkende soorten hebben geen impact op LSVI

