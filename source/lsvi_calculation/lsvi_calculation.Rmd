---
title: "LSVI calculation"
output: html_document
date: "2024-06-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(git2rdata)
library(LSVI)
library(n2khab)
library(n2khabmon)
library(sf)
library(leaflet)
library(DT)

source("functions_lsvi_calc.R")
maakConnectiePool()
```

# Overview of MHQ schemes

```{r}

types <- read_types()

schemes <- read_schemes()

scheme_types <- read_scheme_types()

mhq_schemes <- schemes %>%
  filter(programme == "MHQ") %>%
  select(programme, scheme) %>%
  left_join(select(scheme_types, scheme, type), by = "scheme") %>%
  left_join(select(types, type, typeclass), by = "type")
```

```{r}
mhq_schemes %>%
  datatable(rownames = FALSE,
            filter = "top")
```


# Raw data

## INBOVEG data

```{r}
path_mhq_terr <- file.path(fileman_up("n2khab-mhq-data"), "processed/inboveg_mhq_terr")

path_mhq_terr_raw <- file.path(fileman_up("n2khab-mhq-data"), "raw/structure_variables")

classif_mhq_inbo <- get_type_inboveg(path_mhq_terr)

header_mhq_inbo <- get_header(path_mhq_terr)

```

## Fieldmap data

```{r}

path_mhq_anb <- file.path(fileman_up("n2khab-mhq-data"), "processed/fieldmap_mhq")

classif_mhq_anb <- read_vc(root = path_mhq_anb, file = "type_observed")
structure_mhq_anb <- read_vc(root = path_mhq_anb, file = "structure_vars")
vegetation_mhq_anb <- read_vc(root = path_mhq_anb, file = "cover_species")
veglayers_mhq_anb <- get_cover_veglayers_fieldmap(path_mhq_anb)

pq_mhq_anb <- classif_mhq_anb %>%
  distinct(date_assessment, plot_id) %>%
  semi_join(vegetation_mhq_anb, by = c("plot_id", "date_assessment"))
```

## Merge ANB and INBO data

```{r}

pq_mhq_inbo <- header_mhq_inbo %>%
  filter(!survey %in% c("Schelde-estuarium", "N2000meetnet_Bos_91E0_sf")) %>%
  mutate(plot_type = ifelse(area == 9, "square",
                            ifelse(area > 1000, "circle", NA)),
         date = as.Date(vague_date_begin)) %>%
  select(survey, date, record_id, user_reference, plot_type)

pq_mhq_inbo_wide <- pq_mhq_inbo %>%
  filter(!is.na(plot_type)) %>%
  pivot_wider(names_from = "plot_type", values_from = "record_id", names_prefix = "record_id_") %>%
  mutate(ID = str_c(user_reference, "_", date))

classif_mhq_inbo <- classif_mhq_inbo %>%
  filter(!survey %in% c("Schelde-estuarium", "N2000meetnet_Bos_91E0_sf")) %>%
  left_join(select(pq_mhq_inbo, record_id, plot_type), by = "record_id") %>%
  filter(plot_type == "square") %>%
  rename(record_id_square = record_id) %>%
  left_join(pq_mhq_inbo_wide, by = c("survey", "record_id_square"))

pq_mhq_anb <- pq_mhq_anb %>%
  mutate(ID = str_c(plot_id, "_", date_assessment),
         survey = "anb") %>%
  select(survey, date = date_assessment, ID) %>%
  mutate(record_id_square = ID,
         record_id_circle = ID)
  
classif_mhq_anb <- classif_mhq_anb %>%
  filter(segment_id == 1) %>%
  mutate(type_observed = ifelse(!is.na(type_observed_square), type_observed_square, type_observed_circle),
         ID = str_c(plot_id, "_", date_assessment),
         plot_type = "square",
         survey = "anb") %>%
  select(ID, survey, type_observed, plot_type) %>%
  inner_join(pq_mhq_anb, by = c("survey", "ID"))

type_info <- types %>%
  group_by(main_type) %>%
  mutate(has_subtypes = any(typelevel == "subtype")) %>%
  ungroup() %>%
  select(type_observed = type, typelevel, has_subtypes)

classif_mhq <- classif_mhq_inbo %>%
  bind_rows(classif_mhq_anb) %>%
  select(survey, ID, record_id_square, record_id_circle, date, type_observed, plot_type, type_cover) %>%
  left_join(type_info, by = "type_observed") %>%
  mutate(is_type_target = type_observed %in% mhq_schemes$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(mhq_schemes$type, 1, 4),
         subtype_defined = !(has_subtypes & typelevel == "main_type")) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         type_cover_all = str_c(str_c(type_cover, "% ", type_observed), collapse = "; ")) %>%
  ungroup() %>%
  filter(is_maintype_target)

data_habitat <- classif_mhq %>%
  select(ID, survey, record_id_square, record_id_circle, date, type_observed, subtype_defined, type_cover, type_cover_all)
  
```


# Grasland and marsh habitats

```{r}

schemes_gr_bm <- mhq_schemes %>%
  filter(typeclass %in% c("GR", "BMF", "CH")) %>%
  filter(type != "1330_da")

```

```{r}
schemes_gr_bm %>%
  datatable(rownames = FALSE,
            filter = "top")
  
```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_gr_bm$type),
                            Versie = "Versie 3") 
```


```{r}
overzicht_lsvi %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde) %>%
  datatable(rownames = FALSE,
            filter = "top")
```

## Invoergegevens

```{r}

data_habitat_gr_bm <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_gr_bm$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_gr_bm$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "6410", "6410_mo",
                              type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target) %>%
  filter(!type_observed %in% c("1330_da", "1330_pol"))

check <- data_habitat_gr_bm %>%
  group_by(ID) %>%
  filter(n() > 1)

voorwaarden_circle <- get_voorwaarden_gr_bm(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                                            data_path_extravar = path_mhq_terr_raw,
              record_ids = c(data_habitat_gr_bm$record_id_circle)) %>%
  filter(Indicator %in% c("verbossing", "structuurschade", "microreliëf", "strooisellaag")) %>%
  mutate(plot_type = "circle")

voorwaarden_square <- get_voorwaarden_gr_bm(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                                            data_path_extravar = path_mhq_terr_raw,
              record_ids = data_habitat_gr_bm$record_id_square) %>%
  filter(Indicator %in% c("strooisellaag")) %>%
  mutate(plot_type = "square")

data_voorwaarden_gr_bm <- voorwaarden_circle %>%
  bind_rows(voorwaarden_square)

check <- data_voorwaarden_gr_bm %>%
  group_by(ID, plot_type, Voorwaarde) %>%
  filter(n() > 1)

data_soorten_kenm_gr_bm <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                                            data_path_fieldmap = path_mhq_anb,
                          record_ids = data_habitat_gr_bm$record_id_square)  %>%
                           mutate(Kenmerk = ifelse(str_detect(Kenmerk, "Taraxacum Wiggers"),
                                                              "Taraxacum", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Sphagnum magellanicum"),
                                                              "Sphagnum magellanicum Brid. s.l.", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Warnstorfia fluitans"),
                                                              "Warnstorfia", Kenmerk),
                                  Kenmerk = ifelse(str_detect(Kenmerk, "Drepanocladus aduncus"),
                                                              "Drepanocladus", Kenmerk))

check <- data_soorten_kenm_gr_bm %>%
  group_by(ID, Kenmerk, Waarde, Vegetatielaag) %>%
  filter(n() > 1)
```

## Volledigheid van de invoergegevens

### Specificatie Habitatsubtype

+ 6410: we veronderstellen 6410_mo (lsvi berekening is identiek aan 6410_ve)
+ 6510: we berekenen lsvi voor de subtype 

```{r}

subtypes_6510 <- types %>%
  filter(main_type == "6510") %>%
  filter(typelevel == "subtype") %>%
  select(type_observed = main_type, Habitattype = type) 

data_habitat_6510 <- data_habitat_gr_bm %>%
  filter(type_observed == "6510") %>%
  select(-Habitattype) %>%
  left_join(subtypes_6510, by = "type_observed")

data_habitat_gr_bm <- data_habitat_gr_bm %>%
  anti_join(data_habitat_6510, by = "ID") %>%
  bind_rows(data_habitat_6510)
```

### Voorwaarden

+ Structuurschade 
+ Verbossing
+ Strooisellaag
+ Microreliëf

```{r}
voorwaarden_grl_bm <- overzicht_lsvi %>%
  filter(Indicator %in% c("structuurschade", "verbossing", "strooisellaag", "microreliëf")) %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) 

indicator_plot_type <- data_voorwaarden_gr_bm %>%
  distinct(Indicator, plot_type)

check_voorwaarden <- data_habitat_gr_bm %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_grl_bm, by = "Habitatsubtype") %>%
  left_join(indicator_plot_type, by = "Indicator") %>%
  left_join(data_voorwaarden_gr_bm, by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))
  
voorwaarden_waarde_missing <- check_voorwaarden %>%
  filter(is.na(Waarde)) %>%
  filter(Indicator != "strooisellaag") %>%
  select(record_id_square, record_id_circle, ID, date, type_observed, Indicator, Waarde)

check_strooisellaag <- check_voorwaarden %>%
  filter(Indicator == "strooisellaag") %>%
  distinct(survey, record_id_square, record_id_circle,  date, ID, plot_type, Indicator, Waarde) %>%
  pivot_wider(names_from = "plot_type",
              names_prefix = "cover_",
              values_from = "Waarde") %>%
  mutate(diff_status = (cover_circle <= 10) != (cover_square <= 10))

overzicht_strooisellaag <- check_strooisellaag %>%
  group_by(diff_status) %>%
  summarise(n = n()) %>%
  ungroup()

voorwaarden_waarde_missing %>%
  write_csv2("../../output/structuurschade_verbossing_missing.csv")

check_strooisellaag %>%
  write_csv2("../../output/strooisellaag_missing.csv")
```

Srooisellaag wordt vanaf 2022 uitsluitend in de vierkante plot bepaalt. 
We selecteren dus de waarde voor strooisellaag uit de vierkante plot.

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

```{r}
data_voorwaarden_gr_bm <- check_voorwaarden %>%
  filter(!(plot_type == "circle" & Indicator == "strooisellaag")) %>%
  mutate(Waarde = ifelse(Indicator == "strooisellaag",
                         ifelse(is.na(Waarde) & !is.na(record_id_square), 0, Waarde),
                         ifelse(is.na(Waarde) & !is.na(record_id_circle), 0, Waarde)),
         Type = "Percentage",
         Eenheid = "%",
         record_id = ifelse(plot_type == "square",
                                  record_id_square,
                                  record_id_circle)) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique()

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_gr_bm  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_gr_bm, by = c("record_id"))

check_missingvalue <- data_habitat_gr_bm  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_gr_bm, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_kenmerk %>%
  select(record_id, ID, Habitattype, Vegetatielaag, Kenmerk, Waarde) %>%
  write_csv2("../../output/check_vegopname.csv")

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_gr_bm %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)

data_soorten_kenm_gr_bm <- data_soorten_kenm_gr_bm %>%
  filter(!is.na(Kenmerk),
         !is.na(Waarde))
  
```
Ontbrekende soortnamen meestal mos spec.

### Uittesten LSVI-berkening en beoordeling van impact van warning op LSVI-berekening

#### TEST 1330_hpr

OK

```{r, eval = FALSE}
data_habitat_test <- data_habitat_gr_bm %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  filter(Habitattype != "1330_da")

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "1330_hpr") 

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Drepanocladus aduncus (Hedw.) Warnst..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in berekenLSVIbasis(Versie = "Versie 3", Kwaliteitsniveau = 1, Data_habitat = data_habitat_test_type,  :
  De waarde(n) voor de voorwaarde(n) differentiatie in zout- en tredplanten (VoorwaardeID 2152) kunnen niet berekend worden voor opname(n) 908981_2016-09-15, 455349_2015-08-03, 996353_2015-08-24, 472065_2015-08-24, 1117877_2015-08-20, 736949_2015-08-12, 212661_2015-08-13, 801793_2015-08-19, 540341_2015-08-14, 437685_2015-08-06, 37557_2015-08-11, 798133_2015-08-11, 695297_2015-08-19, 1348277_2017-09-29, 299701_2017-09-29, 1403657_2017-09-29, 1785525_2018-07-04, 1830581_2018-07-04, 1928193_2018-06-29, 1872565_2018-06-28, 1715637_2018-06-28, 1936821_2018-06-28, 1945013_2018-06-28, 1667357_2018-06-14, 1750129_2018-06-29, 1547265_2018-06-29, 1461001_2018-06-14, 2239241_1330_hpr_2019-10-29, 1498805_1330_hpr_2019-10-29, 1594037_1330_hpr_2019-10-29, 2364085_1330_hpr_2019-10-29, 2143233_1330_hpr_2019-10-17, 2333697_1330_hpr_2019-10-31, 2805181_2020-10-15, 3067325_2020-10-15, 2018749_2020-10-15, 2936253_2020-10-15, 3492617_2020-08-07, 2595841_2020-08-18, 3062785_2020-08-18, 3054593_2020-08-18, 165 [... truncated]

--> mossoort niet herkend --> geen impact op LSVI

#### TEST 6230_ha

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_ha")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_resultaat_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```

geen warnings

#### TEST 6230_hmo

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hmo")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
geen warnings

#### TEST 6230_hn

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hn")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6230_hnk

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6230_hnk")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6410_mo

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6410_mo")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6410_ve

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "6410_ve")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type[1,],
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6510_hu

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hu")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Taraxacum Wiggers sectie Subvulgaria Christians., Dicranella species.  Check de spelling en/of laat de auteursnaam weg bij genera.

--> naam "Taraxacum Wiggers sectie Subvulgaria Christians." veranderen naar "Taraxacum"

#### TEST 6510_huk

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_huk")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 6510_hus

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hus")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Criterium, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
geen warnings

#### TEST 6510_hua

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "6510_hua")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

geen warnings

#### TEST 7140_oli

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "7140_oli")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Sphagnum magellanicum Brid..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 1465330_2020-09-24 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 1470454_2021-08-18 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 1470454_2021-08-18 zijn in de struiklaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 170798_2023-10-16 zijn in de kruidlaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)

naam "Sphagnum magellanicum Brid." veranderen in "Sphagnum magellanicum Brid. s. l." 

#### TEST 7140_meso

```{r, eval = FALSE}

data_habitat_test_type <- data_habitat_gr_bm %>%
  filter(Habitattype == "7140_meso")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_voorwaarden = data_voorwaarden_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test_detail <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Warnstorfia fluitans (Hedw.) Loeske, Drepanocladus aduncus (Hedw.) Warnst..  Check de spelling en/of laat de auteursnaam weg bij genera.

--> Warnstorfia fluitans (Hedw.) Loeske veranderen naar Warnstorfia --> OK
--> Drepanocladus aduncus (Hedw.) Warnst. veranderen naar Drepanocladus --> OK

### LSVI-berekening

```{r}

input_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/gr_bm/input") 

write_vc(data_voorwaarden_gr_bm, file = "data_voorwaarden_gr_bm", root = input_path, 
         sorting = c("ID", "Voorwaarde"))
write_vc(data_habitat_gr_bm, file = "data_habitat_gr_bm", root = input_path, 
         sorting = c("ID", "Habitattype"))
write_vc(data_soorten_kenm_gr_bm, file = "data_soorten_kenm_gr_bm", root = input_path, 
         sorting = c("ID", "Vegetatielaag", "Kenmerk"))

lsvi_gr_bm <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_gr_bm,
                         Data_voorwaarden = data_voorwaarden_gr_bm,
                         Data_soortenKenmerken = data_soorten_kenm_gr_bm,
                         na.rm = TRUE)

lsvi_path <- file.path(fileman_up("n2khab-mhq-data"), "processed/lsvi_mhq/gr_bm/result") 

write_lsvi_results(lsvi_gr_bm, path = lsvi_path, suffix = "_gr_bm")

```

```{r}
lsvi_gr_bm_globaal %>%
  ggplot(aes(fill = Status, x = Habitattype)) +
  geom_bar() +
  coord_flip()
```


# Dune habitat types

```{r}

schemes_cd <- mhq_schemes %>%
  filter(typeclass %in% c("CD")) 

```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_cd$type),
                            Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling)

```

## Invoergegevens

```{r}

data_habitat_cd <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_cd$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_cd$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "6410", "6410_mo",
                              type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target)

check <- data_habitat_cd %>%
  group_by(ID) %>%
  filter(n() > 1)

data_voorwaarden_cd <- get_voorwaarden_cd(data_path = path_mhq_terr,
                          record_ids = c(data_habitat_cd$record_id_square,
                                         data_habitat_cd$record_id_circle)) %>%
  left_join(select(pq_mhq_inbo, record_id, plot_type), by = "record_id") %>%
  mutate(plot_type = ifelse(!Voorwaarde %in% c("fijnmazige afwisseling", "bedekking alle mossen"), "circle", plot_type)) %>%
  unique()

data_soorten_kenm_cd <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                          record_ids = data_habitat_cd$record_id_square) 

check <- data_soorten_kenm_cd %>%
  group_by(ID, Kenmerk, Waarde, Vegetatielaag) %>%
  filter(n() > 1)
```

```{r}
data_habitat_test <- data_habitat_cd %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup()
```

## Volledigheid van de invoergegevens

### Voorwaarden

```{r}
voorwaarden_cd <- overzicht_lsvi %>%
  semi_join(data_voorwaarden_cd, by = "Voorwaarde") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) 

voorwaarde_plot_type <- data_voorwaarden_cd %>%
  distinct(Voorwaarde, plot_type, Eenheid, Type) %>%
  filter(!((Voorwaarde %in% c("fijnmazige afwisseling", "bedekking alle mossen")) & (plot_type ==  "circle")))

check_voorwaarden <- data_habitat_cd %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_cd, by = "Habitatsubtype") %>%
  left_join(voorwaarde_plot_type, by = "Voorwaarde") %>%
  left_join(select(data_voorwaarden_cd, -Eenheid, -Type), by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))

open_plek_circle <- check_voorwaarden %>%
  filter(Voorwaarde == "open plekken aanwezig")
 
open_plek_square <- get_cover_veglayers(data_path, record_ids = open_plek_circle$record_id_square) %>%
  filter(layer_code %in% c("NB")) %>%
  rename(record_id_square = recording_givid) %>%
  select(record_id_square, cover_square = cover)

check_open_plek <- open_plek_circle %>%
  left_join(open_plek_square, by = "record_id_square") 

voorwaarden_waarde_missing <- check_voorwaarden %>%
  filter(is.na(Waarde)) %>%
  filter(Voorwaarde != "open plekken aanwezig") %>%
  filter(!(Voorwaarde == "fijnmazige afwisseling" & plot_type == "circle")) %>%
  select(record_id_square, record_id_circle, date, Habitatsubtype, Indicator, Voorwaarde, Waarde)

voorwaarden_waarde_missing %>%
  write_csv2("../../output/cd_indicatoren_missing.csv")

check_open_plek %>%
  write_csv2("../../output/cd_open_plek_missing.csv")
```

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

Open plek:
+ Als waarde ontbreekt voor cirkelplot gebruiken we waarde van vierkante plot
+ Als waarde ook ontbreekt in vierkante plot --> 0

```{r}

data_open_plek <- check_open_plek %>%
  mutate(plot_type = ifelse(is.na(Waarde) & !is.na(cover_square), "square", plot_type),
          Waarde = ifelse(is.na(Waarde),
                         ifelse(is.na(cover_square), 0, cover_square),
                         Waarde))

data_voorwaarden_cd <- check_voorwaarden %>%
  filter(!((plot_type == "circle") & (Voorwaarde == "fijnmazige afwisseling"))) %>%
  filter(Voorwaarde != "open plekken aanwezig") %>%
  mutate(Waarde = ifelse(is.na(Waarde) , 0, Waarde)) %>%
  bind_rows(data_open_plek) %>%
  mutate(record_id = ifelse(plot_type == "square",
                                  record_id_square,
                                  ifelse(!is.na(record_id_circle), 
                                         record_id_circle, record_id_square))) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique()

data_soorten_kenm_cd <- data_soorten_kenm_cd %>%
  filter(!is.na(Kenmerk))

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_cd  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_cd, by = c("record_id"))

check_missingvalue <- data_habitat_cd  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_cd, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_kenmerk %>%
  select(recording_givid, ID, Habitattype, Vegetatielaag, Kenmerk, Waarde) %>%
  write_csv2("../../output/cd_check_vegopname.csv")

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_cd %>%
  filter(!is.na(Kenmerk)) %>%
  group_by(ID, recording_givid, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)
  
```

10578737_2120_2018-09-27, 10342193_2120_2019-10-15, 3807153_2120_2020-08-24 -> 100% naakte bodem in vierkante plot
601649_2021-08-17 -> gegevens vegopname ontbreekt want 4 struweelsoorten aanwezig

Soms komen dezelfde soorten meerdere keren voor in vegopname in zelfde laag. Maar dat is dan één keer als kiemplant.

## TEST 2120

+ spontane verstuiving: OK als niet 100% gefixeerd

+ belang structuurverstoring --> b WT --> < 1%

+ horizontale structuur: helm aanwezig en open zand aanwezig

+ naakte bodem --> via kartering

+ bedekking mos: bedekking moslaag / (100 - bedekking naakte bodem) * 100

+ wat met 100% naakte bodem?

```{r}

data_habitat_test_type <- data_habitat_cd %>%
  filter(Habitattype == "2120")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

## TEST 2130_hd

OK

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2130_hd")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
## TEST 2130_had

OK

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2130_had")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```
## TEST 2160

+ minstens 2 ontwikkelingsstadia aanwezig: pionier, ontwikkeling, climax, degeneratie
+ open plek minstens WT: >= 1%

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2160")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

## TEST 2170

OK

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2170")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```


## TEST 2180


+ enkel indicatoren kruidlaag

+ vegetatielagen indien ingeschat op cirkelplot

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2180")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

## TEST 2190_mp

OK

```{r}

data_habitat_test_type <- data_habitat_test %>%
  filter(Habitattype == "2190_mp")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_cd %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)

```

# Heath habitat types

```{r}

schemes_hs_id <- mhq_schemes %>%
  filter(typeclass %in% c("ID", "HS")) 

```

```{r}
overzicht_lsvi <- geefInvoervereisten(Kwaliteitsniveau = 1,
                            Habitattype = as.character(schemes_hs_id$type),
                            Versie = "Versie 3") %>%
  distinct(Habitatsubtype, Versie, Criterium, Indicator, Voorwaarde, Beoordeling)

```

## Invoergegevens

```{r}

data_habitat_hs_id <- data_habitat %>%
  mutate(is_type_target = type_observed %in% schemes_hs_id$type,
         is_maintype_target = str_sub(type_observed, 1, 4) %in% str_sub(schemes_hs_id$type, 1, 4)) %>%
  group_by(ID) %>%
  mutate(any_type_target = any(is_type_target),
         n_type_target = sum(is_type_target),
         cover_target = sum(type_cover * is_type_target),
         Habitattype = ifelse(type_observed == "6410", "6410_mo",
                              type_observed)) %>%
  ungroup() %>%
  filter(is_maintype_target) %>%
  filter(!str_detect(survey, "Grasland|Moeras"))

check <- data_habitat_hs_id %>%
  group_by(ID) %>%
  filter(n() > 1)

data_voorwaarden_hs_id <- get_voorwaarden_hs_id(data_path_fieldmap = path_mhq_anb,
                                                data_path_inboveg = path_mhq_terr,
                          record_ids = c(data_habitat_hs_id$record_id_square,
                                         data_habitat_hs_id$record_id_circle)) %>%
  mutate(plot_type = "circle")

data_soorten_kenm_hs_id <- get_soorten_kenmerken(data_path_inboveg = path_mhq_terr,
                                                 data_path_fieldmap = path_mhq_anb,
                         record_ids =  data_habitat_hs_id$record_id_square) %>%
  bind_rows(get_kenmerken_open_zand(data_path_fieldmap = path_mhq_anb,
                                                data_path_inboveg = path_mhq_terr,
                          record_ids = c(data_habitat_hs_id$record_id_square,
                                         data_habitat_hs_id$record_id_circle)))

```

## Volledigheid van de invoergegevens

### Voorwaarden

```{r}
voorwaarden_hs_id  <- overzicht_lsvi %>%
  semi_join(data_voorwaarden_hs_id , by = "Voorwaarde") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) %>%
  mutate(Voorwaarde = ifelse(Habitatsubtype == "2310" & Indicator == "horizontale structuur", 
                             "bedekking open vegetaties en kaal zand", 
                             Voorwaarde))

voorwaarde_plot_type <- data_voorwaarden_hs_id  %>%
  distinct(Voorwaarde, plot_type, Eenheid, Type)

check_voorwaarden <- data_habitat_hs_id  %>%
  rename(Habitatsubtype = Habitattype) %>%
  left_join(voorwaarden_hs_id , by = "Habitatsubtype") %>%
  left_join(voorwaarde_plot_type, by = "Voorwaarde") %>%
  left_join(select(data_voorwaarden_hs_id , -Eenheid, -Type), by = c("ID", "Criterium", "Indicator", "Voorwaarde", "plot_type")) %>%
  filter(!is.na(Voorwaarde))

voorwaarden_record_missing <- check_voorwaarden %>%
  filter(is.na(record_id)) %>%
  select(ID, record_id_square, record_id_circle, date, Habitatsubtype, Indicator, Voorwaarde, Waarde)

voorwaarden_waarde_missing %>%
  write_csv2("../../output/heide_indicatoren_missing.csv")

```

Na controle: ontbrekende waarden = 0 indien er een opname in inboveg zit.

```{r}

data_voorwaarden_hs_id <- check_voorwaarden %>%
  mutate(Waarde = ifelse(is.na(Waarde) & !is.na(record_id), 0, Waarde)) %>%
  select(ID, record_id, plot_type, Criterium, Indicator, Voorwaarde, Waarde, Type, Invoertype, Eenheid) %>%
  unique() %>%
  mutate(Voorwaarde = ifelse(Voorwaarde == "bedekking open vegetaties en kaal zand",
                             "bedekking open vegetaties", Voorwaarde)) %>%
  unique()

```

### Vegetatiegegevens

```{r}
check_missingveg <- data_habitat_hs_id  %>%
  rename(record_id = record_id_square) %>%
  anti_join(data_soorten_kenm_hs_id, by = c("record_id"))

check_missingvalue <- data_habitat_hs_id  %>%
  rename(record_id = record_id_square) %>%
  left_join(data_soorten_kenm_hs_id, by = c("record_id", "ID"))

missing_kenmerk <- check_missingvalue %>%
  filter(is.na(Kenmerk))

missing_cover <- check_missingvalue %>%
  filter(is.na(Waarde))

double <- data_soorten_kenm_hs_id %>%
  filter(!is.na(Kenmerk)) %>%
  group_by(ID, record_id, Kenmerk, Vegetatielaag) %>%
  filter(n() > 1)
  
data_soorten_kenm_hs_id <- data_soorten_kenm_hs_id %>%
  filter(!is.na(Kenmerk))
```

Ontbrekende soortnamen in kruidlaag --> Calluna dood, Erica dood
Ontbrekende soortnamen in korstmoslaag --> korstmos spec. 

geen impact op LSVI

Ontbrekende bedekking wel een probleem: sleutelsoorten moeten talrijk aanwezig zijn.

```{r}
data_habitat_test <- data_habitat_hs_id %>%
  group_by(Habitattype) %>%
  slice_head(n = 1) %>%
  ungroup()
```

## TEST 2310

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "2310")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Polytrichum species, Pseudoscleropodium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 476086_2014-09-04 zijn in de moslaag de synoniemen 'Polytrichum species' en 'Pseudoscleropodium species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossoorten --> heeft geen impact op LSVI --> OK


## TEST 2330_bu

```{r}
data_habitat_test_type <- data_habitat_hs_id%>%
  filter(Habitattype == "2330_bu")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Polytrichum species, Dicranella species, Leptobryum species, Taraxacum Wiggers sectie Subvulgaria Christians., Pohlia species, Eurhynchium species, Hypnum species.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 1547090_2017-07-13 zijn in de moslaag de synoniemen 'Dicranella species' en 'Leptobryum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 177078_2014-09-10 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 225910_2014-09-23 zijn in de moslaag de synoniemen 'Dicranella species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 714230_2016-09-28 zijn in de moslaag de synoniemen 'Eurhynchium species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
--> mossen geen impact op LSVI
--> 1 record met Taraxacum Wiggers sectie Subvulgaria Christians. --> geen impact op LSVI

## TEST 2330_dw

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "2330_dw")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```

Aandeel meerjarige kruiden wordt berekend als de som van de bedekking van alles soorten exclusief éénjarigen; dus bedekking van bomen wordt ook meegrekend: OK?

Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species.  Check de spelling en/of laat de auteursnaam weg bij genera.
  --> OK

## TEST 4010

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "4010")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Sphagnum species, Dicranella species, Hypnum species, Sphagnum magellanicum Brid..  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 120110_2014-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2015-09-24 zijn in de moslaag de synoniemen 'Dicranella species' en 'Sphagnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 35090_2019-08-21 zijn in de struiklaag de synoniemen 'Betula alba L.' en 'Betula pendula Roth' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)

Sphagnum magellanicum Brid. --> geen sleutelsoort
13 anb-plots met Sphagnum species --> worden niet meegerekend als sleutelsoort

## TEST 4030

```{r}
data_habitat_test_type <- data_habitat_hs_id %>%
  filter(Habitattype == "4030")

test <- berekenLSVIbasis(Versie = "Versie 3",
                         Kwaliteitsniveau = 1,
                         Aggregatiemethode = "RapportageHR",
                         Data_habitat = data_habitat_test_type,
                         Data_soortenKenmerken = data_soorten_kenm_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"),
                         Data_voorwaarden = data_voorwaarden_hs_id %>%
                           semi_join(data_habitat_test_type, by = "ID"))

test <- test$Resultaat_detail %>%
  select(ID, Habitattype, Indicator, Belang, Voorwaarde, Referentiewaarde, Operator, Waarde, Status_voorwaarde, Verschilscore)
```
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Volgende soortnamen zijn niet teruggevonden in de databank: Dicranella species, Hypnum species, Polytrichum species, Fontinalis species, Pseudoscleropodium species, Sphagnum species, Taraxacum Wiggers sectie Subvulgaria Christians., Bryum species, ANDERE SOORT.  Check de spelling en/of laat de auteursnaam weg bij genera.
Warning in invoercontroleData_soortenKenmerken(Data_soortenKenmerken, ConnectieLSVIhabitats,  :
  Voor opname 21430_2014-09-09 zijn in de moslaag de synoniemen 'Dicranella species' en 'Hypnum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap); Voor opname 42934_2014-09-10 zijn in de moslaag de synoniemen 'Fontinalis species' en 'Polytrichum species' beschouwd als eenzelfde taxon met aggregatie van de bedekkingen (rekening houdend met gedeeltelijke overlap)
  
  
--> Niet herkende soorten hebben geen impact op LSVI

